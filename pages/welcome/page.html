<div id="welcome-page">
  <h1 class="welcome app-title">Casmurro</h1>
  <h3 class="welcome app-subtitle" >Um bom começo para sua história</h3>

  <div class="welcome newProjetcBtn">
    <button id="dialog-link" class="ui-button ui-corner-all ui-widget"><span class="ui-icon ui-icon-plusthick"></span> Novo Projeto</button>
  </div>
  <div id="project-list"></div>

  
  <!-- ui-dialog -->
  <div id="dialog" title="Novo projeto">
    <div class="welcome">
      <p>Título do projeto: </p>
      <form id="form">
        <input type="text" id="projectName" class="welcome text ui-corner-all fullwidth">
      </form>
    </div>
      <h6>
        Ao adicionar um novo projeto, você concorda que esta ciente dos termos de uso.
      </h6>
  </div>
</div>
<script>
  console.log('chamou Welcome (dentro)');
  $( "#dialog" ).dialog({
	autoOpen: false,
	width: 600,
	buttons: [
		{
			text: "Ok",
      id: "okBtn",
      disabled: false,
			click: async function() {
        await createNewProject();
        $( this ).dialog( "close" );
        pageChange('#dinamicPage', 'pages/dashboard/page.html')
			}
		},
		{
			text: "Cancel",
			click: function() {
				$( this ).dialog( "close" );
			}
		}
	]
});

// Link to open the dialog
$( "#dialog-link" ).click(function( event ) {
	$( "#dialog" ).dialog( "open" );
  $( "#okBtn" ).addClass( "ui-button-disabled ui-state-disabled" )
	event.preventDefault();
});

function validateNewProject() {
  const inputName = document.getElementById("projectName");
  inputName.addEventListener('input', (event) => {
    const inputValue = inputName.value
    if (!inputValue) {
      $( "#okBtn" ).addClass( "ui-button-disabled ui-state-disabled" )
    } else {
      $( "#okBtn" ).removeClass( "ui-button-disabled ui-state-disabled" )
    }
  });
}

async function createNewProject() {
  const inputName = document.getElementById("projectName");
  const currentDate = new Date();
  const timeStamp = Date.now();
  console.log(typeof(timeStampI));
  const idNew = await db.projects.add(
    { title: inputName.value,
      status: "novo",
      cards_qty: 0,
      literary_genre: null,
      description: null,
      image_cover: null,
      created_at: currentDate,
      last_edit: currentDate,
      timestamp: timeStamp,
    }).then();
  const updadeCurrent = await db.settings.update(1,{ currentproject: idNew });
  inputName.value = '';
  return updadeCurrent;
};

function disableNavBar() {
  const navBarButtons = document.querySelectorAll(".navtrigger");
  navBarButtons.forEach( (buton) => {
    buton.style.display = 'none';
  })
}

async function setProjectAtual(id) {
  const result = await db.settings.update(1, {currentproject: id});
  pageChange('#dinamicPage', 'pages/dashboard/page.html');
  return result;
}

async function listProjects() {
  const result = await db.projects.orderBy('timestamp').desc();
  await result.each(function (project) {
      const dateEdit = convertDateBR(project.last_edit);
      const timeEdit = convertToTime(project.last_edit);
      $('#project-list').append(
        `
        <ul class="projectsList">
          <li class="projectsItens zoom">
          <a class="projectsName" onclick="setProjectAtual(${ project.id })">
          <img src="${ !project.image_cover ? 'assets/images/manuscript.jpeg' : project.image_cover }" class="coverImage"> 
              <div>
                <p class="projectTitle">${ project.title }</p>
                <p class="projectCreated"><span class="ui-icon ui-icon-calendar"></span>Modificado em: <strong>${ dateEdit }</strong> | <strong>${ timeEdit }</strong></p>
              </div>
              <span class="projectStatus"> ${ project.status } </span>
              <div>${ !project.literary_genre ? '' : project.literary_genre }</div>
              <div class="cards">
                <p class="projectTitle"><strong>${ project.cards_qty }</strong></p>
                <p class="projectCreated">Cartões</p>  
              </div>
          </a>
          </li>
        </ul>
        `
      );
    })
  changeStatusColor()
  return result
}

function changeStatusColor() {
  const statusHtml = document.querySelectorAll(".projectStatus");
  statusHtml.forEach( (elem) => {
    const classStatus = elem.innerText;
    const n = classStatus.split(" ").pop();
    elem.classList.add(n);
  })
}

restoreBackground() 

$( document ).ready(function() {
  listProjects();
  validateNewProject();
  disableNavBar();
});

</script>