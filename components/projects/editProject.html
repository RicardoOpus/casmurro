<div class="editProjectMain">
  <div class="backArrow">
    <a onclick="pageChange('#dinamicPage', 'pages/dashboard/page.html')">❮ voltar</a>
  </div>
  <div class="card">
    <input class="editProjectTitle projectInputForm" id="title">
    <p class="delete"><span class="ui-icon ui-icon-trash"></span><a id="deleteProject"> Excluir projeto</a></p>
    <div class="editProjectTable">
      <div class="editProjectBlock">
        <h3>Tipo literário:</h3>
        <select class="projectInputForm ui-selectmenu-button ui-selectmenu-button-closed ui-corner-all ui-button ui-widget" id="literary_genre">
          <option disabled selected value> -- selecione -- </option>
          <option value="Romance">Romance</option>
          <option value="Novela">Novela</option>
          <option value="Noveleta">Noveleta</option>
          <option value="Conto">Conto</option>
          <option value="Outro">Outro</option>
        </select>
        <h3>Status:</h3>
        <select class="projectInputForm ui-selectmenu-button ui-selectmenu-button-closed ui-corner-all ui-button ui-widget" id="status">
          <option disabled selected value> -- selecione -- </option>
          <option value="novo">Novo</option>
          <option value="em andamento">Em andamento</option>
          <option value="pausado">Pausado</option>
          <option value="concluído">Concluído</option>
          <option value="outro">Outro</option>
        </select>
      </div>
      <div class="editProjectBlock">
        <h3>Data de início:</h3>
        <input class="cardInputNormal projectInputForm" id="created_at" type="date" timezone="[[timezone]]"> 
      </div>
    </div>

    <div>
      <h3>Descrição:</h3>
      <p class="editProjectSpan">Um resumo sobre o projeto</p>
      <textarea class="cardInputNormal projectInputForm projectInputResume" type="textarea" rows="8" id="description"></textarea>
    </div>
  
  </div>
  <div class="card">
    <h3>Wallpaper</h3>
      <input type="file" id="my-image" class="inputFile ui-corner-all ui-widget">
      <div>
        <input id="btnSaveWall" type="button" value="Atualizar Wallpaper" class="ui-button ui-corner-all btnSmall" onclick="saveProjectCover()">
        <input type="button" value="Restaurar padrão" class="ui-button ui-corner-all btnSmall" onclick="restoreProjectCover()">
      </div>
  </div>
</div>


<!-- ui-dialog -->
<div id="dialog-delete-project" title="Excluir projeto">
    <h4>
      Tem certeza que deseja excluir este projeto?
    </h4>
    <p style="font-size: medium;">
      Todas as informações serão perdidas.
      <br>Esta ação não poderá ser desfeita.
    </p>
</div>

<script>
  async function restoreProjectData() {
  const project = await db.settings.get(1);
  const projectID = project.currentproject;
  const projectData = await db.projects.get(projectID);
  const dateConverted = convertDateBR(projectData.created_at);
  const date = convertDateUS(dateConverted);
  Object.keys(projectData).forEach(key => {
    const result = document.getElementById(key);
    if (key === 'created_at') {
      return result.value = date;
    } if (key === 'last_edit') {
      return null
    } if (result) {
      return result.value = projectData[key];
    } 
  })
}
restoreProjectData()

var elementsArray = document.querySelectorAll(".projectInputForm");

elementsArray.forEach(async function(elem) {
  const project = await db.settings.get(1);
  const projectID = project.currentproject;
    elem.addEventListener("input", async () => {
      const obj = { oldKey: elem.value };
      obj[elem.id] = obj['oldKey'];
      delete obj['oldKey'];
      if (Object.keys(obj)[0] === "created_at") {
        const dateObject = new Date(obj.created_at); // cria data
        const tomorrow = new Date(dateObject);
        const dateSum1 = tomorrow.setDate(dateObject.getDate()+1);
        const correctDate = new Date(dateSum1)
        obj['created_at'] = correctDate;
        db.projects.update(projectID, obj);
      } else {
        db.projects.update(projectID, obj);
      }
    });
});

async function deleteProject() {
  const project = await db.settings.get(1);
  const projectID = project.currentproject;
  return await db.projects.delete(projectID);
}

$( "#dialog-delete-project" ).dialog({
	autoOpen: false,
	width: 500,
	buttons: [
		{
			text: "Ok",
			click: async function() {
        await deleteProject();
        $( this ).dialog( "close" );
        loadpage('welcome');
			}
		},
		{
			text: "Cancel",
      id: "btnTwo",
			click: function() {
				$( this ).dialog( "close" );
			}
		}
	]
});

async function saveProjectCover() {
  console.log("clicou");
  const projectActual = await db.settings.toArray();
  const idProject = await projectActual[0].currentproject;
  const projectData = await db.projects.get(idProject);
  const fileInput = document.querySelector('#my-image');
  const file = fileInput.files[0];
  const reader = new FileReader();
  reader.onloadend = async () => {
    const base64String = reader.result
    await db.projects.update(projectData.id, {image_cover: base64String})
  };
  reader.readAsDataURL(file);
  pageChange('#dinamicPage', 'pages/dashboard/page.html')
};

async function restoreProjectCover() {
  const projectActual = await db.settings.toArray();
  const idProject = await projectActual[0].currentproject;
  const projectData = await db.projects.get(idProject);
  await db.projects.update(projectData.id, {image_cover: null})
  pageChange('#dinamicPage', 'pages/dashboard/page.html')
};

// Link to open the dialog
$( "#deleteProject" ).click(function( event ) {
	$( "#dialog-delete-project" ).dialog( "open" );
  $("#btnTwo").focus();
	event.preventDefault();
});

function verify() {
  document.getElementById("btnSaveWall").disabled = false;
};

document.getElementById("btnSaveWall").disabled = true;
var teste = document.getElementById("my-image");
teste.addEventListener('input', () => {
  verify();
});

</script>
